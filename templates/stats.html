<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosplay Analysis Dashboard v4.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
</head>
<body class="bg-slate-100 min-h-screen pb-20">
    
    <div class="bg-white shadow-sm p-4 mb-6 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                <i class="fa-solid fa-chart-line text-blue-500 mr-2"></i>分析インサイト
            </h2>
            <a href="/" class="text-blue-500 hover:text-blue-700 font-bold border border-blue-500 px-4 py-2 rounded-lg transition hover:bg-blue-50">
                <i class="fa-solid fa-arrow-left mr-2"></i>リストに戻る
            </a>
        </div>
    </div>

    <div class="container mx-auto px-4">
        {% if stats %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-indigo-500">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Analyzed Tweets</p>
                <p class="text-4xl font-black text-gray-800 mt-2">{{ stats.total_tweets }}</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Avg Save Rate</p>
                <p class="text-4xl font-black text-blue-600 mt-2">{{ stats.avg_save_rate }}<span class="text-xl">%</span></p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-400">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Avg Engagement</p>
                <p class="text-4xl font-black text-yellow-500 mt-2">{{ stats.avg_eng_rate }}<span class="text-xl">%</span></p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <div class="bg-white p-6 rounded-xl shadow-lg col-span-1 lg:col-span-2">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-bullseye text-red-500 mr-2"></i>4-Quadrant Strategy Matrix
                </h3>
                <p class="text-xs text-gray-400 mb-4">ドットをクリックすると画像を確認できます</p>
                <div class="h-96 w-full">
                    <canvas id="mainMatrix"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-person-dress text-pink-500 mr-2"></i>肌色露出度 vs 保存率
                </h3>
                <div class="h-64 w-full">
                    <canvas id="skinChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fa-regular fa-clock text-blue-500 mr-2"></i>投稿時間帯別パフォーマンス
                </h3>
                <div class="h-64 w-full">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
            <div class="bg-indigo-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold flex items-center text-lg">
                    <i class="fa-solid fa-crown mr-2 text-yellow-400"></i>保存率トップ10（神投稿・隠れた名作）
                </h3>
                <span class="text-indigo-100 text-xs">Based on {{ stats.total_tweets }} samples</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-indigo-50 text-indigo-600 text-xs uppercase tracking-widest font-bold">
                        <tr>
                            <th class="p-4">Rank</th>
                            <th class="p-4">Preview</th>
                            <th class="p-4">Save Rate</th>
                            <th class="p-4">Skin Ratio</th>
                            <th class="p-4">Time</th>
                            <th class="p-4">Quadrant</th>
                        </tr>
                    </thead>
                    <tbody id="topTable" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </div>

        {% else %}
        <div class="flex flex-col items-center justify-center py-20 text-center">
            <i class="fa-solid fa-database text-6xl text-gray-200 mb-4"></i>
            <h2 class="text-xl font-bold text-gray-500">データが読み込めません</h2>
            <p class="text-gray-400 mt-2">解析が完了するまでお待ちください。</p>
        </div>
        {% endif %}
    </div>

    <div id="imageModal" class="fixed inset-0 bg-black/90 hidden z-[100] flex items-center justify-center p-4 cursor-pointer" onclick="this.classList.add('hidden')">
        <div class="bg-white p-2 rounded-lg max-w-lg w-full relative">
            <img id="modalImg" src="" class="w-full h-auto rounded shadow-2xl">
            <div id="modalText" class="p-4 text-center font-bold text-gray-800"></div>
            <div class="absolute -top-4 -right-4 bg-red-500 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-lg">
                <i class="fa-solid fa-xmark"></i>
            </div>
        </div>
    </div>

    <script>
        // Annotationプラグインの登録
        Chart.register(window['chartjs-plugin-annotation']);

        const stats = {{ stats|tojson }};
        console.log("Stats Loaded:", stats);

        if (stats && stats.total_tweets > 0) {
            
            // --- 1. ランキングテーブル生成 ---
            const topTweets = [...stats.raw_tweets]
                .sort((a, b) => b.save_rate - a.save_rate)
                .slice(0, 10);
                
            const tableBody = document.getElementById('topTable');
            topTweets.forEach((t, i) => {
                const isGod = t.save_rate > stats.avg_save_rate && t.engagement_rate > stats.avg_eng_rate;
                const status = isGod ? 
                    '<span class="bg-purple-100 text-purple-600 px-2 py-1 rounded text-[10px] font-black border border-purple-200">神投稿</span>' : 
                    '<span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-[10px] font-black border border-blue-200">隠れた名作</span>';
                
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 transition";
                row.innerHTML = `
                    <td class="p-4 font-black text-gray-400 text-xl">#${i+1}</td>
                    <td class="p-2">
                        <img src="${t.images[0].path}" class="h-20 w-16 object-cover rounded shadow cursor-pointer hover:opacity-80 transition" onclick="showModal('${t.images[0].path}', 'Save Rate: ${t.save_rate}%')">
                    </td>
                    <td class="p-4 font-black text-blue-600 text-lg">${t.save_rate}%</td>
                    <td class="p-4 text-gray-600 font-bold">${t.images[0].skin_ratio}%</td>
                    <td class="p-4 text-gray-400 text-sm font-mono">${t.created_at ? t.created_at.split('T')[1].substring(0,5) : '-'}</td>
                    <td class="p-4">${status}</td>
                `;
                tableBody.appendChild(row);
            });

            // --- 2. 4象限マトリクス (Scatter) ---
            new Chart(document.getElementById('mainMatrix'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Posts',
                        data: stats.scatter_data,
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        pointRadius: 6,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const id = stats.scatter_data[idx].id;
                            const tweet = stats.raw_tweets.find(t => t.tweet_id === id);
                            if (tweet) showModal(tweet.images[0].path, `Save: ${tweet.save_rate}% / Eng: ${tweet.engagement_rate}%`);
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                lineY: { type: 'line', yMin: stats.avg_save_rate, yMax: stats.avg_save_rate, borderColor: 'rgba(0,0,0,0.2)', borderDash: [5,5] },
                                lineX: { type: 'line', xMin: stats.avg_eng_rate, xMax: stats.avg_eng_rate, borderColor: 'rgba(0,0,0,0.2)', borderDash: [5,5] }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Engagement (%)' } },
                        y: { title: { display: true, text: 'Save Rate (%)' } }
                    }
                }
            });

            // --- 3. 肌色率チャート ---
            const skinData = stats.skin_scatter || [];
            new Chart(document.getElementById('skinChart'), {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '全身・バストアップ',
                            data: skinData.filter(d => d.comp !== 'Face Close-up'),
                            backgroundColor: 'rgba(236, 72, 153, 0.7)',
                            pointRadius: 5
                        },
                        {
                            label: '顔アップ (ノイズ)',
                            data: skinData.filter(d => d.comp === 'Face Close-up'),
                            backgroundColor: 'rgba(59, 130, 246, 0.4)',
                            pointStyle: 'crossRot',
                            pointRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { min: 0, max: 100, title: { display: true, text: '肌色率 (%)' } },
                        y: { title: { display: true, text: '保存率 (%)' } }
                    }
                }
            });

            // --- 4. 時間帯チャート ---
            new Chart(document.getElementById('timeChart'), {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}時`),
                    datasets: [{
                        label: '平均保存率',
                        data: stats.hourly_stats,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // モーダル表示用関数
        function showModal(src, text) {
            document.getElementById('modalImg').src = src;
            document.getElementById('modalText').innerText = text;
            document.getElementById('imageModal').classList.remove('hidden');
        }
    </script>
</body>
</html>