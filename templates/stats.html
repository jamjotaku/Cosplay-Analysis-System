<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Helvetica Neue', Arial, sans-serif; }
        .stat-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); height: 100%; }
        .big-number { font-size: 2.5rem; font-weight: bold; color: #2c3e50; }
        .label-text { color: #7f8c8d; font-size: 0.9rem; text-transform: uppercase; }
        .top-rank-img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; margin-right: 10px; }
        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å†…ã®ç”»åƒã‚¹ã‚¿ã‚¤ãƒ« */
        #chartjs-tooltip { opacity: 1; position: absolute; background: rgba(0, 0, 0, 0.8); color: white; border-radius: 8px; pointer-events: none; transform: translate(-50%, 0); transition: all .1s ease; padding: 10px; z-index: 100; max-width: 150px; text-align: center; }
        .tooltip-img { width: 100%; border-radius: 5px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ“Š åˆ†æã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <a href="/" class="btn btn-outline-primary">â† ãƒªã‚¹ãƒˆã«æˆ»ã‚‹</a>
        </div>

        {% if stats %}
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="stat-card text-center">
                    <div class="label-text">åˆ†ææ¸ˆã¿ãƒ„ã‚¤ãƒ¼ãƒˆæ•°</div>
                    <div class="big-number">{{ stats.total_tweets }}</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card text-center">
                    <div class="label-text">å¹³å‡ ä¿å­˜ç‡ (Save Rate)</div>
                    <div class="big-number text-primary">{{ stats.avg_save_rate }}%</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card text-center">
                    <div class="label-text">å¹³å‡ ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</div>
                    <div class="big-number text-warning">{{ stats.avg_eng_rate }}%</div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="stat-card">
                    <h4 class="mb-3">ğŸ¯ æˆ¦ç•¥ãƒãƒˆãƒªã‚¯ã‚¹ (4-Quadrant Matrix)</h4>
                    <p class="small text-muted mb-4">
                        ç¸¦è»¸ï¼šä¿å­˜ç‡ (Save) / æ¨ªè»¸ï¼šã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ (Eng)<br>
                        <strong>å³ä¸Š: ç¥æŠ•ç¨¿ (God Tier)</strong> | <strong>å³ä¸‹: ãƒã‚º (Viral)</strong> | <strong>å·¦ä¸Š: ãŠå® (Hidden Gem)</strong>
                    </p>
                    <div style="height: 500px; width: 100%;">
                        <canvas id="scatterChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="stat-card">
                    <h5>ğŸ“ æ§‹å›³åˆ¥ã®å¹³å‡ä¿å­˜ç‡</h5>
                    <canvas id="compChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card">
                    <h5>ğŸ’¡ æ˜ã‚‹ã•åˆ¥ã®åå¿œç‡</h5>
                    <canvas id="brightChart"></canvas>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="stat-card">
                    <h5 class="mb-3">ğŸ† ä¿å­˜ç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚° TOP5</h5>
                    <table class="table align-middle">
                        <tbody>
                            {% for tweet in stats.top_tweets %}
                            <tr>
                                <td width="50"><h4 class="text-muted m-0">#{{ loop.index }}</h4></td>
                                <td width="70">
                                    {% if tweet.images %}
                                    <img src="{{ tweet.images[0].path }}" class="top-rank-img">
                                    {% endif %}
                                </td>
                                <td>
                                    <div><strong>ID: {{ tweet.tweet_id }}</strong></div>
                                    <span class="badge bg-light text-dark">{{ tweet.images[0].composition if tweet.images else '' }}</span>
                                </td>
                                <td class="text-end">
                                    <span class="badge bg-primary rounded-pill p-2" style="font-size:1rem;">Save: {{ tweet.save_rate }}%</span>
                                </td>
                                <td class="text-end"><a href="{{ tweet.url }}" target="_blank" class="btn btn-sm btn-light">è¦‹ã‚‹</a></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            // ãƒ‡ãƒ¼ã‚¿å—ã‘å–ã‚Š
            const scatterData = {{ stats.scatter_data | tojson }};
            const avgSave = {{ stats.avg_save_rate }};
            const avgEng = {{ stats.avg_eng_rate }};
            const compData = {{ stats.composition_stats | tojson }};
            const brightData = {{ stats.brightness_stats | tojson }};

            // --- 1. æ•£å¸ƒå›³ (Scatter Chart) ---
            const ctxScatter = document.getElementById('scatterChart').getContext('2d');
            new Chart(ctxScatter, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Post',
                        data: scatterData,
                        backgroundColor: (ctx) => {
                            // è±¡é™ã«ã‚ˆã£ã¦è‰²ã‚’å¤‰ãˆã‚‹
                            const v = ctx.raw;
                            if (!v) return 'rgba(100, 100, 100, 0.5)';
                            if (v.y >= avgSave && v.x >= avgEng) return 'rgba(255, 99, 132, 1)'; // å³ä¸Š: ç¥ (èµ¤)
                            if (v.y >= avgSave && v.x < avgEng) return 'rgba(54, 162, 235, 1)';  // å·¦ä¸Š: ãŠå® (é’)
                            if (v.y < avgSave && v.x >= avgEng) return 'rgba(255, 206, 86, 1)';  // å³ä¸‹: ãƒã‚º (é»„)
                            return 'rgba(201, 203, 207, 1)'; // å·¦ä¸‹: æ™®é€š (ã‚°ãƒ¬ãƒ¼)
                        },
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            title: { display: true, text: 'Engagement Rate (%)' },
                            grid: { color: (ctx) => ctx.tick.value === 0 ? 'black' : '#e5e5e5' }
                        },
                        y: { 
                            title: { display: true, text: 'Save Rate (%)' },
                            grid: { color: (ctx) => ctx.tick.value === 0 ? 'black' : '#e5e5e5' }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `ID: ${ctx.raw.id} (Save: ${ctx.raw.y}%, Eng: ${ctx.raw.x}%)`
                            }
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: avgSave, yMax: avgSave,
                                    borderColor: 'rgba(0,0,0,0.3)', borderWidth: 2, borderDash: [6, 6],
                                    label: { display: true, content: `Avg Save: ${avgSave}%`, position: 'end' }
                                },
                                line2: {
                                    type: 'line',
                                    xMin: avgEng, xMax: avgEng,
                                    borderColor: 'rgba(0,0,0,0.3)', borderWidth: 2, borderDash: [6, 6],
                                    label: { display: true, content: `Avg Eng: ${avgEng}%`, position: 'end', rotation: 90 }
                                }
                            }
                        }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const url = scatterData[index].url;
                            window.open(url, '_blank');
                        }
                    }
                }
            });

            // --- 2. æ§‹å›³ãƒãƒ£ãƒ¼ãƒˆ ---
            new Chart(document.getElementById('compChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(compData),
                    datasets: [{
                        label: 'Save Rate (%)',
                        data: Object.values(compData),
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });

            // --- 3. æ˜ã‚‹ã•ãƒãƒ£ãƒ¼ãƒˆ ---
            new Chart(document.getElementById('brightChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(brightData),
                    datasets: [{
                        data: Object.values(brightData),
                        backgroundColor: ['#ffcd56', '#343a40', '#c0c0c0']
                    }]
                }
            });
        </script>
        {% else %}
        <div class="alert alert-warning">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšã¯åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</div>
        {% endif %}
    </div>
</body>
</html>