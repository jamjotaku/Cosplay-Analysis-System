<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Insights | v4.6</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen pb-24">
    
    <nav class="bg-white/80 backdrop-blur shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h2 class="text-xl font-bold text-slate-800">ğŸ“Š åˆ†æã‚¤ãƒ³ã‚µã‚¤ãƒˆ</h2>
            <a href="/" class="text-blue-500 hover:text-blue-700 font-bold flex items-center transition">
                <i class="fa-solid fa-arrow-left mr-2"></i>ä¸€è¦§ã«æˆ»ã‚‹
            </a>
        </div>
    </nav>

    <div class="container mx-auto px-6 mt-8">
        {% if stats %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100 border-l-8 border-l-indigo-500">
                <p class="text-slate-400 text-xs font-black uppercase tracking-widest">Analyzed Tweets</p>
                <p class="text-4xl font-black text-slate-800 mt-2">{{ stats.total_tweets }}</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100 border-l-8 border-l-blue-500">
                <p class="text-slate-400 text-xs font-black uppercase tracking-widest">Avg Save Rate</p>
                <p class="text-4xl font-black text-blue-600 mt-2">{{ stats.avg_save_rate }}%</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-yellow-100 border-l-8 border-l-yellow-400">
                <p class="text-slate-400 text-xs font-black uppercase tracking-widest">Avg Engagement</p>
                <p class="text-4xl font-black text-yellow-500 mt-2">{{ stats.avg_eng_rate }}%</p>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-xl overflow-hidden mb-10 border border-slate-100">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6">
                <h3 class="text-white font-bold text-xl flex items-center">
                    <i class="fa-solid fa-wand-magic-sparkles mr-3"></i>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆåˆ†æ
                </h3>
                <p class="text-purple-100 text-xs mt-1">ã©ã®è¨€è‘‰ãŒä¿å­˜ç‡ $y$ ã«æœ€ã‚‚è²¢çŒ®ã—ã¦ã„ã‚‹ã‹ã‚’æŠ½å‡º [cite: 2026-02-12]</p>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                    <div class="space-y-4">
                        <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">High Save-Rate Keywords</h4>
                        <div id="keywordList" class="grid grid-cols-1 gap-3">
                            </div>
                    </div>
                    <div class="bg-slate-50 p-8 rounded-2xl border border-slate-100 relative">
                        <i class="fa-solid fa-quote-left absolute top-4 left-4 text-slate-200 text-4xl"></i>
                        <h4 class="font-bold text-indigo-700 mb-4 flex items-center">
                            <i class="fa-solid fa-robot mr-2"></i>AIåˆ†æå®˜ã®ãƒ†ã‚­ã‚¹ãƒˆæˆ¦ç•¥
                        </h4>
                        <p id="aiInsight" class="text-sm text-slate-600 leading-relaxed z-10 relative">
                            </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-8 rounded-3xl shadow-lg mb-10 border border-slate-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold flex items-center text-slate-800">
                    <i class="fa-solid fa-bullseye text-red-500 mr-2"></i>4-Quadrant Strategy Matrix
                </h3>
                <span class="text-[10px] text-slate-400 italic underline">ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æŠ•ç¨¿ç”»åƒã‚’ç¢ºèª</span>
            </div>
            <div class="h-96 w-full">
                <canvas id="mainMatrix"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <div class="bg-white p-8 rounded-3xl shadow-lg border border-slate-100">
                <h3 class="text-lg font-bold mb-6 flex items-center">
                    <i class="fa-solid fa-person-dress text-pink-500 mr-2"></i>è‚Œè‰²éœ²å‡ºåº¦ vs ä¿å­˜ç‡
                </h3>
                <div class="h-64 w-full"><canvas id="skinChart"></canvas></div>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-lg border border-slate-100">
                <h3 class="text-lg font-bold mb-6 flex items-center">
                    <i class="fa-regular fa-clock text-blue-500 mr-2"></i>æŠ•ç¨¿æ™‚é–“å¸¯åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
                </h3>
                <div class="h-64 w-full"><canvas id="timeChart"></canvas></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <div class="bg-white p-8 rounded-3xl shadow-lg border-t-4 border-green-500">
                <h3 class="text-lg font-bold mb-6">ğŸ“¸ æ§‹å›³åˆ¥ ä¿å­˜åŠ¹ç‡ (Avg)</h3>
                <div class="h-64 w-full"><canvas id="compEfficiencyChart"></canvas></div>
            </div>
            <div class="bg-white p-8 rounded-3xl shadow-lg border-t-4 border-orange-500">
                <h3 class="text-lg font-bold mb-6">ğŸ† å‹è€…ã®æ¡ä»¶ (Top 10 vs All)</h3>
                <div id="comparisonBox" class="space-y-6">
                    </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
            <div class="bg-slate-900 p-6 flex justify-between items-center">
                <h3 class="text-white font-bold text-xl flex items-center">
                    <i class="fa-solid fa-crown text-yellow-400 mr-3"></i>ä¿å­˜ç‡ãƒˆãƒƒãƒ—10ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                </h3>
                <span class="text-slate-400 text-xs">Updated in real-time</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-slate-500 text-[10px] font-black uppercase tracking-widest border-b border-slate-100">
                        <tr>
                            <th class="p-6">Rank</th>
                            <th class="p-6">Preview</th>
                            <th class="p-6">Save Rate</th>
                            <th class="p-6">Skin %</th>
                            <th class="p-6">Time</th>
                            <th class="p-6">Status</th>
                        </tr>
                    </thead>
                    <tbody id="topTable" class="divide-y divide-slate-50">
                        </tbody>
                </table>
            </div>
        </div>
        {% else %}
        <div class="flex flex-col items-center justify-center py-32 opacity-20 text-slate-400 text-center">
            <i class="fa-solid fa-database text-8xl mb-4"></i>
            <p class="text-xl font-bold italic uppercase">Awaiting Data Streams...</p>
        </div>
        {% endif %}
    </div>

    <div id="imageModal" class="fixed inset-0 bg-slate-900/95 hidden z-[100] flex items-center justify-center p-6 cursor-pointer transition-opacity duration-300" onclick="this.classList.add('hidden')">
        <div class="bg-white p-2 rounded-2xl max-w-lg w-full shadow-2xl overflow-hidden" onclick="event.stopPropagation()">
            <img id="modalImg" src="" class="w-full h-auto rounded-xl">
            <div id="modalText" class="p-6 text-center font-black text-slate-800 text-lg"></div>
        </div>
    </div>

    <script>
        Chart.register(window['chartjs-plugin-annotation']);
        const stats = {{ stats|tojson }};

        if (stats && stats.total_tweets > 0) {
            
            // --- A. Keyword & Insight Logic ---
            const kwList = document.getElementById('keywordList');
            if(stats.keyword_ranking && stats.keyword_ranking.length > 0) {
                stats.keyword_ranking.slice(0, 8).forEach(kw => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-4 bg-white border border-slate-100 rounded-xl shadow-sm hover:border-purple-300 transition group cursor-default";
                    div.innerHTML = `
                        <span class="font-bold text-slate-700 group-hover:text-purple-600 transition">#${kw.word}</span>
                        <div class="text-right">
                            <span class="text-purple-600 font-black block text-lg">${kw.avg_save}%</span>
                            <span class="text-[9px] text-slate-400 uppercase font-bold tracking-tighter">${kw.count} Posts</span>
                        </div>
                    `;
                    kwList.appendChild(div);
                });
                const topKw = stats.keyword_ranking[0];
                document.getElementById('aiInsight').innerHTML = `
                    ãƒ‡ãƒ¼ã‚¿è§£æã®çµæœã€<b>ã€Œ#${topKw.word}ã€</b>ã¨ã„ã†å˜èªã‚’å«ã‚€æŠ•ç¨¿ã¯ã€å¹³å‡ä¿å­˜ç‡ãŒ <b>${topKw.avg_save}%</b> ã¨æ¥µã‚ã¦é«˜ã„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç™ºæ®ã—ã¦ã„ã¾ã™ã€‚<br><br>
                    ã“ã‚Œã¯å…¨ä½“ã®å¹³å‡ï¼ˆ${stats.avg_save_rate}%ï¼‰ã‚’å¤§ããä¸Šå›ã£ã¦ãŠã‚Šã€ãƒ•ã‚¡ãƒ³ãŒã“ã®å˜èªã«ä»˜éšã™ã‚‹ã€Œã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚„ã€Œã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€ã‚’å¼·ãæ±‚ã‚ã¦ã„ã‚‹è¨¼æ‹ ã§ã™ã€‚æ¬¡å›ã®æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆã«å¿…ãšå«ã‚ã‚‹ã¹ãã€Œãƒ‘ãƒ¯ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€ã¨è¨€ãˆã‚‹ã§ã—ã‚‡ã†ã€‚
                `;
            } else {
                document.getElementById('aiInsight').innerText = "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è§£æã«ååˆ†ãªãƒ‡ãƒ¼ã‚¿ãŒã¾ã è“„ç©ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚500ä»¶ã‚’ç›®æŒ‡ã—ã¦è§£æã‚’ç¶™ç¶šã—ã¦ãã ã•ã„ã€‚";
            }

            // --- B. Top 10 Comparison ---
            const top10 = [...stats.raw_tweets].sort((a,b) => b.save_rate - a.save_rate).slice(0, 10);
            const topAvgSkin = (top10.reduce((acc, t) => acc + (t.images[0].skin_ratio || 0), 0) / 10).toFixed(1);
            const allAvgSkin = (stats.skin_scatter.reduce((acc, s) => acc + s.x, 0) / stats.skin_scatter.length).toFixed(1);

            document.getElementById('comparisonBox').innerHTML = `
                <div class="p-6 bg-orange-50 rounded-2xl border border-orange-100 flex justify-between items-center group">
                    <span class="font-bold text-slate-700">ğŸ† ä¸Šä½10ä»¶ã®å¹³å‡è‚Œè‰²ç‡</span>
                    <span class="text-orange-600 font-black text-2xl group-hover:scale-110 transition">${topAvgSkin}%</span>
                </div>
                <div class="p-6 bg-slate-100 rounded-2xl flex justify-between items-center">
                    <span class="font-bold text-slate-700">ğŸ“Š å…¨ä½“ã®å¹³å‡è‚Œè‰²ç‡</span>
                    <span class="text-slate-500 font-black text-2xl">${allAvgSkin}%</span>
                </div>
                <p class="text-xs text-slate-400 italic px-2">
                    çµè«–: ç¾åœ¨ã€ä¸Šä½æŠ•ç¨¿ã¯å…¨ä½“ã‚ˆã‚Š <b>${Math.abs(topAvgSkin - allAvgSkin).toFixed(1)}%</b> 
                    ${topAvgSkin > allAvgSkin ? 'éœ²å‡ºãŒé«˜ã„' : 'éœ²å‡ºãŒä½ã„'}å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚
                </p>
            `;

            // --- C. Ranking Table ---
            const tableBody = document.getElementById('topTable');
            top10.forEach((t, i) => {
                const isGod = t.save_rate > stats.avg_save_rate && t.engagement_rate > stats.avg_eng_rate;
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-50 transition-colors group cursor-pointer";
                row.innerHTML = `
                    <td class="p-6 font-black text-slate-200 group-hover:text-slate-400 transition text-2xl italic">#${i+1}</td>
                    <td class="p-4"><img src="${t.images[0].path}" class="h-20 w-16 object-cover rounded-lg shadow-md group-hover:scale-110 transition cursor-zoom-in" onclick="showModal('${t.images[0].path}', 'Save Rate: ${t.save_rate}%')"></td>
                    <td class="p-6 font-black text-blue-600 text-xl">${t.save_rate}%</td>
                    <td class="p-6 text-slate-600 font-bold">${t.images[0].skin_ratio}%</td>
                    <td class="p-6 text-slate-400 text-sm font-mono">${t.created_at ? t.created_at.split('T')[1].substring(0,5) : '-'}</td>
                    <td class="p-6">${isGod ? '<span class="bg-purple-100 text-purple-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border border-purple-200 shadow-sm shadow-purple-100">God Tier</span>' : '<span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border border-blue-200 shadow-sm shadow-blue-100">Hidden Gem</span>'}</td>
                `;
                tableBody.appendChild(row);
            });

            // --- D. Chart Visualizations ---
            // Matrix Chart
            new Chart(document.getElementById('mainMatrix'), {
                type: 'scatter',
                data: { datasets: [{ label: 'Posts', data: stats.scatter_data, backgroundColor: 'rgba(52, 152, 219, 0.6)', pointRadius: 8, pointHoverRadius: 12 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, elements) => { 
                        if (elements.length > 0) { 
                            const idx = elements[0].index; 
                            const t = stats.raw_tweets.find(x => x.tweet_id === stats.scatter_data[idx].id); 
                            if (t) showModal(t.images[0].path, `Save: ${t.save_rate}% / ID: ${t.tweet_id}`); 
                        } 
                    },
                    plugins: { 
                        annotation: { annotations: {
                            lineY: { type: 'line', yMin: stats.avg_save_rate, yMax: stats.avg_save_rate, borderColor: 'rgba(0,0,0,0.1)', borderDash: [6,6], borderWidth: 2 },
                            lineX: { type: 'line', xMin: stats.avg_eng_rate, xMax: stats.avg_eng_rate, borderColor: 'rgba(0,0,0,0.1)', borderDash: [6,6], borderWidth: 2 }
                        }},
                        legend: { display: false }
                    },
                    scales: { 
                        x: { title: { display: true, text: 'Engagement (%)', font: { weight: 'bold' } }, grid: { display: false } }, 
                        y: { title: { display: true, text: 'Save Rate (%)', font: { weight: 'bold' } }, grid: { color: 'rgba(0,0,0,0.03)' } } 
                    }
                }
            });

            // Skin Chart
            new Chart(document.getElementById('skinChart'), {
                type: 'scatter',
                data: { datasets: [
                    { label: 'å…¨èº«ãƒ»ãƒã‚¹ãƒˆã‚¢ãƒƒãƒ—', data: stats.skin_scatter.filter(d => d.comp !== 'Face Close-up'), backgroundColor: 'rgba(236, 72, 153, 0.6)', pointRadius: 6 },
                    { label: 'é¡”ã‚¢ãƒƒãƒ—', data: stats.skin_scatter.filter(d => d.comp === 'Face Close-up'), backgroundColor: 'rgba(59, 130, 246, 0.3)', pointStyle: 'crossRot', pointRadius: 8 }
                ]},
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { min: 0, max: 100, title: { display: true, text: 'è‚Œè‰²ç‡ (%)' } } }
                }
            });

            // Time Chart
            new Chart(document.getElementById('timeChart'), {
                type: 'bar',
                data: { 
                    labels: Array.from({length: 24}, (_, i) => `${i}h`), 
                    datasets: [{ label: 'Avg Save Rate', data: stats.hourly_stats, backgroundColor: 'rgba(59, 130, 246, 0.6)', borderRadius: 8 }] 
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { grid: { display: false } } } }
            });

            // Composition Chart
            new Chart(document.getElementById('compEfficiencyChart'), {
                type: 'bar',
                data: { 
                    labels: Object.keys(stats.comp_efficiency), 
                    datasets: [{ label: 'Efficiency (%)', data: Object.values(stats.comp_efficiency), backgroundColor: 'rgba(34, 197, 94, 0.6)', borderRadius: 8 }] 
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true } } }
            });
        }

        function showModal(src, text) {
            document.getElementById('modalImg').src = src;
            document.getElementById('modalText').innerText = text;
            const modal = document.getElementById('imageModal');
            modal.classList.remove('hidden');
        }
    </script>
</body>
</html>