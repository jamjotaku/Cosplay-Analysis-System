<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosplay Analysis Dashboard v4.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
</head>
<body class="bg-slate-100 min-h-screen pb-20">
    
    <div class="bg-white shadow-sm p-4 mb-6 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                <i class="fa-solid fa-chart-line text-blue-500 mr-2"></i>åˆ†æã‚¤ãƒ³ã‚µã‚¤ãƒˆ
            </h2>
            <a href="/" class="text-blue-500 hover:text-blue-700 font-bold border border-blue-500 px-4 py-2 rounded-lg transition hover:bg-blue-50">
                <i class="fa-solid fa-arrow-left mr-2"></i>ãƒªã‚¹ãƒˆã«æˆ»ã‚‹
            </a>
        </div>
    </div>

    <div class="container mx-auto px-4">
        {% if stats %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-indigo-500">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Analyzed Tweets</p>
                <p class="text-4xl font-black text-gray-800 mt-2">{{ stats.total_tweets }}</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Avg Save Rate</p>
                <p class="text-4xl font-black text-blue-600 mt-2">{{ stats.avg_save_rate }}%</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-400">
                <p class="text-gray-500 text-xs font-bold uppercase tracking-wider">Avg Engagement</p>
                <p class="text-4xl font-black text-yellow-500 mt-2">{{ stats.avg_eng_rate }}%</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <div class="bg-white p-6 rounded-xl shadow-lg col-span-1 lg:col-span-2">
                <h3 class="text-xl font-bold mb-4 flex items-center justify-between">
                    <span><i class="fa-solid fa-bullseye text-red-500 mr-2"></i>4-Quadrant Strategy Matrix</span>
                    <span class="text-xs text-gray-400 font-normal underline">ãƒ‰ãƒƒãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©³ç´°è¡¨ç¤º</span>
                </h3>
                <div class="h-96 w-full"><canvas id="mainMatrix"></canvas></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-person-dress text-pink-500 mr-2"></i>è‚Œè‰²éœ²å‡ºåº¦ vs ä¿å­˜ç‡
                </h3>
                <div class="h-64 w-full"><canvas id="skinChart"></canvas></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fa-regular fa-clock text-blue-500 mr-2"></i>æŠ•ç¨¿æ™‚é–“å¸¯åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
                </h3>
                <div class="h-64 w-full"><canvas id="timeChart"></canvas></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-chart-simple text-green-500 mr-2"></i>æ§‹å›³åˆ¥ ä¿å­˜åŠ¹ç‡
                </h3>
                <div class="h-64 w-full"><canvas id="compEfficiencyChart"></canvas></div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-orange-500">
                <h3 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-trophy text-orange-500 mr-2"></i>å‹è€…ã®æ¡ä»¶ (Top 10 vs å…¨ä½“)
                </h3>
                <div id="comparisonBox" class="space-y-4">
                    </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
            <div class="bg-indigo-600 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold flex items-center text-lg">
                    <i class="fa-solid fa-crown mr-2 text-yellow-400"></i>ä¿å­˜ç‡ãƒˆãƒƒãƒ—10
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-indigo-50 text-indigo-600 text-xs uppercase font-bold">
                        <tr>
                            <th class="p-4">Rank</th>
                            <th class="p-4">Preview</th>
                            <th class="p-4">Save Rate</th>
                            <th class="p-4">Skin Ratio</th>
                            <th class="p-4">Time</th>
                            <th class="p-4">Status</th>
                        </tr>
                    </thead>
                    <tbody id="topTable" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <div id="imageModal" class="fixed inset-0 bg-black/90 hidden z-[100] flex items-center justify-center p-4 cursor-pointer" onclick="this.classList.add('hidden')">
        <div class="bg-white p-2 rounded-lg max-w-lg w-full relative">
            <img id="modalImg" src="" class="w-full h-auto rounded">
            <div id="modalText" class="p-4 text-center font-bold text-gray-800"></div>
        </div>
    </div>

    <script>
        Chart.register(window['chartjs-plugin-annotation']);
        const stats = {{ stats|tojson }};

        if (stats && stats.total_tweets > 0) {
            
            // --- A. æ¯”è¼ƒåˆ†æã®è¨ˆç®— ---
            const top10 = [...stats.raw_tweets].sort((a,b) => b.save_rate - a.save_rate).slice(0, 10);
            const topAvgSkin = (top10.reduce((acc, t) => acc + (t.images[0].skin_ratio || 0), 0) / 10).toFixed(1);
            const allAvgSkin = (stats.skin_scatter.reduce((acc, s) => acc + s.x, 0) / stats.skin_scatter.length).toFixed(1);

            document.getElementById('comparisonBox').innerHTML = `
                <div class="flex justify-between p-4 bg-orange-50 rounded-lg border border-orange-100">
                    <span class="font-bold text-gray-700">ğŸ† ä¸Šä½10ä»¶ã®å¹³å‡è‚Œè‰²ç‡</span>
                    <span class="text-orange-600 font-black text-xl">${topAvgSkin}%</span>
                </div>
                <div class="flex justify-between p-4 bg-gray-50 rounded-lg">
                    <span class="font-bold text-gray-700">ğŸ“Š å…¨ä½“ã®å¹³å‡è‚Œè‰²ç‡</span>
                    <span class="text-gray-600 font-black text-xl">${allAvgSkin}%</span>
                </div>
                <p class="text-sm text-gray-500 italic p-2">
                    çµè«–: ä¸Šä½æŠ•ç¨¿ã¯å…¨ä½“ã‚ˆã‚Š <b>${Math.abs(topAvgSkin - allAvgSkin).toFixed(1)}%</b> ${topAvgSkin > allAvgSkin ? 'éœ²å‡ºãŒé«˜ã„' : 'éœ²å‡ºãŒä½ã„'}å‚¾å‘ã«ã‚ã‚Šã¾ã™ã€‚
                </p>
            `;

            // --- B. ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã®ç”Ÿæˆ ---
            const tableBody = document.getElementById('topTable');
            top10.forEach((t, i) => {
                const isGod = t.save_rate > stats.avg_save_rate && t.engagement_rate > stats.avg_eng_rate;
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 transition cursor-pointer";
                row.innerHTML = `
                    <td class="p-4 font-black text-gray-400 text-xl">#${i+1}</td>
                    <td class="p-2"><img src="${t.images[0].path}" class="h-20 w-16 object-cover rounded shadow" onclick="showModal('${t.images[0].path}', 'Save: ${t.save_rate}%')"></td>
                    <td class="p-4 font-black text-blue-600 text-lg">${t.save_rate}%</td>
                    <td class="p-4 text-gray-600 font-bold">${t.images[0].skin_ratio}%</td>
                    <td class="p-4 text-gray-400 text-sm font-mono">${t.created_at ? t.created_at.split('T')[1].substring(0,5) : '-'}</td>
                    <td class="p-4">${isGod ? '<span class="bg-purple-100 text-purple-600 px-2 py-1 rounded text-[10px] font-black">ç¥æŠ•ç¨¿</span>' : '<span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-[10px] font-black">éš ã‚ŒãŸåä½œ</span>'}</td>
                `;
                tableBody.appendChild(row);
            });

            // --- C. å„ç¨®ãƒãƒ£ãƒ¼ãƒˆæç”» ---
            // 1. ãƒãƒˆãƒªã‚¯ã‚¹
            new Chart(document.getElementById('mainMatrix'), {
                type: 'scatter',
                data: { datasets: [{ label: 'Posts', data: stats.scatter_data, backgroundColor: 'rgba(52, 152, 219, 0.7)', pointRadius: 7 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const idx = elements[0].index;
                            const t = stats.raw_tweets.find(x => x.tweet_id === stats.scatter_data[idx].id);
                            if (t) showModal(t.images[0].path, `Save: ${t.save_rate}% / ID: ${t.tweet_id}`);
                        }
                    },
                    plugins: {
                        annotation: { annotations: {
                            lineY: { type: 'line', yMin: stats.avg_save_rate, yMax: stats.avg_save_rate, borderColor: 'rgba(0,0,0,0.2)', borderDash: [5,5] },
                            lineX: { type: 'line', xMin: stats.avg_eng_rate, xMax: stats.avg_eng_rate, borderColor: 'rgba(0,0,0,0.2)', borderDash: [5,5] }
                        }}
                    },
                    scales: { x: { title: { display: true, text: 'Engagement (%)' } }, y: { title: { display: true, text: 'Save Rate (%)' } } }
                }
            });

            // 2. è‚Œè‰²ãƒãƒ£ãƒ¼ãƒˆ
            new Chart(document.getElementById('skinChart'), {
                type: 'scatter',
                data: { datasets: [
                    { label: 'å…¨èº«ãƒ»ãƒã‚¹ãƒˆã‚¢ãƒƒãƒ—', data: stats.skin_scatter.filter(d => d.comp !== 'Face Close-up'), backgroundColor: 'rgba(236, 72, 153, 0.7)', pointRadius: 5 },
                    { label: 'é¡”ã‚¢ãƒƒãƒ—', data: stats.skin_scatter.filter(d => d.comp === 'Face Close-up'), backgroundColor: 'rgba(59, 130, 246, 0.4)', pointStyle: 'crossRot', pointRadius: 6 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { min: 0, max: 100, title: { display: true, text: 'è‚Œè‰²ç‡ (%)' } } } }
            });

            // 3. æ™‚é–“å¸¯ãƒãƒ£ãƒ¼ãƒˆ
            new Chart(document.getElementById('timeChart'), {
                type: 'bar',
                data: { labels: Array.from({length: 24}, (_, i) => `${i}æ™‚`), datasets: [{ label: 'å¹³å‡ä¿å­˜ç‡', data: stats.hourly_stats, backgroundColor: 'rgba(59, 130, 246, 0.7)', borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 4. æ§‹å›³åŠ¹ç‡ãƒãƒ£ãƒ¼ãƒˆ (æ–°è¨­)
            new Chart(document.getElementById('compEfficiencyChart'), {
                type: 'bar',
                data: { labels: Object.keys(stats.comp_efficiency), datasets: [{ label: 'å¹³å‡ä¿å­˜ç‡ (%)', data: Object.values(stats.comp_efficiency), backgroundColor: 'rgba(34, 197, 94, 0.7)', borderRadius: 5 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
            });
        }

        function showModal(src, text) {
            document.getElementById('modalImg').src = src;
            document.getElementById('modalText').innerText = text;
            document.getElementById('imageModal').classList.remove('hidden');
        }
    </script>
</body>
</html>