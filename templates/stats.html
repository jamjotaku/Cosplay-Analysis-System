<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-slate-100 min-h-screen pb-12">
    
    <div class="bg-white shadow-sm p-4 mb-6">
        <div class="container mx-auto flex justify-between items-center">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š åˆ†æã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ»ãƒ¬ãƒãƒ¼ãƒˆ</h2>
            <a href="/" class="text-blue-500 hover:text-blue-700 font-bold border border-blue-500 px-4 py-2 rounded-lg transition">
                â† ãƒªã‚¹ãƒˆã«æˆ»ã‚‹
            </a>
        </div>
    </div>

    <div class="container mx-auto px-4">
        
        {% if stats %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-indigo-500">
                <p class="text-gray-500 text-sm font-bold uppercase">åˆ†ææ¸ˆã¿ãƒ„ã‚¤ãƒ¼ãƒˆæ•°</p>
                <p class="text-4xl font-black text-gray-800 mt-2">{{ stats.total_tweets }}</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                <p class="text-gray-500 text-sm font-bold uppercase">å¹³å‡ ä¿å­˜ç‡ (SAVE RATE)</p>
                <p class="text-4xl font-black text-blue-600 mt-2">{{ stats.avg_save_rate }}%</p>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-yellow-400">
                <p class="text-gray-500 text-sm font-bold uppercase">å¹³å‡ ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</p>
                <p class="text-4xl font-black text-yellow-500 mt-2">{{ stats.avg_eng_rate }}%</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="bg-white p-6 rounded-xl shadow-lg col-span-1 lg:col-span-2">
                <h3 class="text-xl font-bold mb-2 flex items-center">
                    <i class="fa-solid fa-bullseye text-red-500 mr-2"></i>æˆ¦ç•¥ãƒãƒˆãƒªã‚¯ã‚¹ (4-Quadrant Matrix)
                </h3>
                <p class="text-sm text-gray-500 mb-4">å³ä¸Š: ç¥æŠ•ç¨¿ (God Tier) | å³ä¸‹: ãƒã‚º (Viral) | å·¦ä¸Š: ãŠå® (Hidden Gem)</p>
                <div class="h-96 w-full">
                    <canvas id="mainMatrix"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-2 flex items-center">
                    <i class="fa-solid fa-person-dress text-pink-500 mr-2"></i>è‚Œè‰²éœ²å‡ºåº¦ vs ä¿å­˜ç‡
                </h3>
                <p class="text-sm text-gray-500 mb-4">éœ²å‡ºãŒå¢—ãˆã‚‹ã¨ä¿å­˜ç‡ã¯ä¸ŠãŒã‚‹ã®ã‹ï¼Ÿã®æ¤œè¨¼</p>
                <div class="h-64 w-full">
                    <canvas id="skinChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-2 flex items-center">
                    <i class="fa-regular fa-clock text-blue-500 mr-2"></i>æŠ•ç¨¿æ™‚é–“å¸¯åˆ¥ å¹³å‡ä¿å­˜ç‡
                </h3>
                <p class="text-sm text-gray-500 mb-4">ä½•æ™‚ã«æŠ•ç¨¿ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã‹ï¼Ÿ (0æ™‚ã€œ23æ™‚)</p>
                <div class="h-64 w-full">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-2 flex items-center">
                    <i class="fa-solid fa-crop-simple text-green-500 mr-2"></i>æ§‹å›³åˆ¥ å¹³å‡ä¿å­˜ç‡
                </h3>
                <div class="h-64 w-full">
                    <canvas id="compChart"></canvas>
                </div>
            </div>

        </div>

        {% else %}
        <div class="text-center py-20">
            <h2 class="text-2xl font-bold text-gray-400">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h2>
            <p class="text-gray-500 mt-2">CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
            <a href="/" class="mt-4 inline-block bg-blue-500 text-white px-6 py-2 rounded-lg">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
        </div>
        {% endif %}
    </div>

    <script>
        const stats = {{ stats|tojson }};
        
        if (stats) {
            // --- 1. ãƒãƒˆãƒªã‚¯ã‚¹ãƒãƒ£ãƒ¼ãƒˆ ---
            const ctxMatrix = document.getElementById('mainMatrix');
            new Chart(ctxMatrix, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Post',
                        data: stats.scatter_data,
                        backgroundColor: (ctx) => {
                            const val = ctx.raw;
                            if (!val) return 'rgba(200, 200, 200, 0.5)';
                            // è‰²åˆ†ã‘: ä¿å­˜ç‡ãŒé«˜ã„=èµ¤, ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãŒé«˜ã„=é»„, ä¸¡æ–¹é«˜ã„=ç´«, ä½ã„=é’
                            if (val.y > stats.avg_save_rate && val.x > stats.avg_eng_rate) return 'rgba(155, 89, 182, 0.8)'; // God
                            if (val.y > stats.avg_save_rate) return 'rgba(231, 76, 60, 0.8)'; // Hidden Gem (High Save)
                            if (val.x > stats.avg_eng_rate) return 'rgba(241, 196, 15, 0.8)'; // Viral
                            return 'rgba(52, 152, 219, 0.6)'; // Normal
                        },
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Engagement Rate (%)' } },
                        y: { title: { display: true, text: 'Save Rate (%)' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `ID: ${ctx.raw.id}`
                            }
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line', yMin: stats.avg_save_rate, yMax: stats.avg_save_rate,
                                    borderColor: 'gray', borderWidth: 2, borderDash: [5, 5],
                                    label: { content: `Avg Save: ${stats.avg_save_rate}%`, enabled: true, position: 'end' }
                                },
                                line2: {
                                    type: 'line', xMin: stats.avg_eng_rate, xMax: stats.avg_eng_rate,
                                    borderColor: 'gray', borderWidth: 2, borderDash: [5, 5],
                                    label: { content: `Avg Eng: ${stats.avg_eng_rate}%`, enabled: true, position: 'start', rotation: 90 }
                                }
                            }
                        }
                    }
                }
            });

            // --- 2. è‚Œè‰²ç‡ãƒãƒ£ãƒ¼ãƒˆ (Scatter) ---
            new Chart(document.getElementById('skinChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Posts',
                        data: stats.skin_scatter,
                        backgroundColor: 'rgba(236, 72, 153, 0.6)', // Pink
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'è‚Œè‰²ç‡ (%)' }, min: 0, max: 100 },
                        y: { title: { display: true, text: 'ä¿å­˜ç‡ (%)' } }
                    }
                }
            });

            // --- 3. æ™‚é–“å¸¯ãƒãƒ£ãƒ¼ãƒˆ (Bar) ---
            new Chart(document.getElementById('timeChart'), {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}æ™‚`),
                    datasets: [{
                        label: 'å¹³å‡ä¿å­˜ç‡ (%)',
                        data: stats.hourly_stats,
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // --- 4. æ§‹å›³ãƒãƒ£ãƒ¼ãƒˆ (Bar) ---
            new Chart(document.getElementById('compChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(stats.composition_stats),
                    datasets: [{
                        label: 'å¹³å‡ä¿å­˜ç‡ (%)',
                        data: Object.values(stats.composition_stats),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y'
                }
            });
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
</body>
</html>